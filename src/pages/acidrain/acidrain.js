import { loadHTML } from '/src/components/monitor/controlMonitor.js';

//=====================================
// üéµ Ïò§ÎîîÏò§ Îß§ÎãàÏ†Ä ÏÑ§Ï†ï (Ïú†Ï†Ä Ïª®Ìä∏Î°§ Ìè¨Ìï®)
// =====================================
import audioManager from '/src/scripts/audiomanager.js';

// BGM ÏÑ§Ï†ï Î∞è Ïû¨ÏÉù ÏãúÏûë
audioManager.setSource('/assets/audio/bgm/acidrain-DiscoHeart-Coyote-Hearing.mp3');
audioManager.audio.volume = 0.1;
audioManager.play();

// ÏÇ¨Ïö¥Îìú ÌÜ†Í∏Ä UI Ïó∞Í≤∞
audioManager.setUI({
  iconSelector: '#soundIcon',
  buttonSelector: '#soundToggleBtn',
});

// =====================================
// Í≤åÏûÑ Ï¥àÍ∏∞ Î≥ÄÏàò Î∞è Îç∞Ïù¥ÌÑ∞
// =====================================
const typingInput = document.querySelector('.typing-input'); // ÌÉÄÏûê ÏûÖÎ†•Ï∞Ω
const scoreDisplay = document.getElementById('score'); // Ï†êÏàò ÌëúÏãú ÏòÅÏó≠
const timeDisplay = document.getElementById('time'); // ÏãúÍ∞Ñ ÌëúÏãú ÏòÅÏó≠
const gameOverModal = document.getElementById('gameOverModal'); // Í≤åÏûÑ Ïò§Î≤Ñ Î™®Îã¨Ï∞Ω
const finalScoreDisplay = document.getElementById('finalScore'); // ÏµúÏ¢Ö Ï†êÏàò ÏòÅÏó≠
const retryBtn = document.getElementById('retryBtn'); // Îã§ÏãúÌïòÍ∏∞ Î≤ÑÌäº
const modalButtons = document.querySelectorAll('.modal-button'); // Î™®Îã¨ ÎÇ¥ Î™®Îì† Î≤ÑÌäº

let score = 0; // ÌòÑÏû¨ Ï†êÏàò
let time = 60; // Ï†úÌïú ÏãúÍ∞Ñ
let dropInterval; // Îã®Ïñ¥ ÏÉùÏÑ± ÌÉÄÏù¥Î®∏
let timerInterval; // ÏãúÍ∞Ñ Í∞êÏÜå ÌÉÄÏù¥Î®∏
const fallingIntervals = []; // ÎÇôÌïò Îã®Ïñ¥Îì§Ïùò Í∞úÎ≥Ñ ÌÉÄÏù¥Î®∏ Ï†ÄÏû• Î∞∞Ïó¥

let focusedButtonIndex = -1; // ‚Üê‚Üí ÌÇ§Î°ú Ìè¨Ïª§Ïä§Îêú Î≤ÑÌäº Ïù∏Îç±Ïä§

// ÎÇôÌïò Îã®Ïñ¥ Î¶¨Ïä§Ìä∏
const words = [
  'ÏÇ¨Í≥º',
  'Î∞îÎÇòÎÇò',
  'ÏàòÎ∞ï',
  'Ìè¨ÎèÑ',
  'ÏûêÎ™Ω',
  'Ï∞∏Ïô∏',
  'Îî∏Í∏∞',
  'Î≥µÏà≠ÏïÑ',
  'Î†àÎ™¨',
  'ÌïôÍµê',
  'ÎèÑÏÑúÍ¥Ä',
  'Î¨∏Î∞©Íµ¨',
  'ÍµêÏã§',
  'ÌïôÏÉù',
  'ÏÑ†ÏÉù',
  'Ïπ†Ìåê',
  'Ïó∞ÌïÑ',
  'ÏßÄÏö∞Í∞ú',
  'ÎÖ∏Ìä∏',
  'ÏûêÎèôÏ∞®',
  'ÎπÑÌñâÍ∏∞',
  'Î≤ÑÏä§',
  'ÏûêÏ†ÑÍ±∞',
  'Ìó¨Í∏∞',
  'Í∏∞Ï∞®',
  'ÏßÄÌïòÏ≤†',
  'ÌÉùÏãú',
  'Ìä∏Îü≠',
  'Ïä§Ïø†ÌÑ∞',
  'Ïª¥Ìì®ÌÑ∞',
  'ÎßàÏö∞Ïä§',
  'ÌÇ§Î≥¥Îìú',
  'Î™®ÎãàÌÑ∞',
  'ÌîÑÎ¶∞ÌÑ∞',
  'ÏΩîÎî©',
  'ÌîÑÎ°úÍ∑∏',
  'ÏûêÎ∞î',
  'Ïä§ÌÅ¨Î¶ΩÌä∏',
  'ÏΩîÎìú',
  'Î∞îÎã§',
  'Ìò∏Ïàò',
  'Í≥ÑÍ≥°',
  'ÏÇ¨Îßâ',
  'Ï¥àÏõê',
  'ÎπôÌïò',
  'Ïó¨Î¶Ñ',
  'Í∞ÄÏùÑ',
  'Í≤®Ïö∏',
  'Î∞îÎûå',
  'Ï≤úÎë•',
  'Î≤àÍ∞ú',
  'ÌñáÎπõ',
  'Îπ®Í∞ï',
  'ÌååÎûë',
  'ÎÖ∏Îûë',
  'Ï¥àÎ°ù',
  'Î≥¥Îùº',
  'ÌïòÏñë',
  'Í≤ÄÏ†ï',
  'ÌöåÏÉâ',
  'Ï£ºÌô©',
  'Í∞àÏÉâ',
  'Ïö∞Ïú†',
  'Ïª§Ìîº',
  'Ï£ºÏä§',
  'ÏΩúÎùº',
  'ÏÇ¨Ïù¥Îã§',
  'Îß•Ï£º',
  'ÏôÄÏù∏',
  'ÏÜåÏ£º',
  'ÏÇ¨Îûë',
  'Ïö∞Ï†ï',
  'ÌñâÎ≥µ',
  'Í∏∞ÏÅ®',
  'Ïä¨Ìîî',
  'Î∂ÑÎÖ∏',
  'Í±±Ï†ï',
  'Ìù¨Îßù',
  'Ïö©Í∏∞',
  'ÎëêÎ†§ÏõÄ',
  'ÌïúÍµ≠',
  'ÏùºÎ≥∏',
  'Ï§ëÍµ≠',
  'ÎØ∏Íµ≠',
  'ÏòÅÍµ≠',
  'ÎèÖÏùº',
  'ÌîÑÎûëÏä§',
  'Ïù¥ÌÉàÎ¶¨ÏïÑ',
  'Îü¨ÏãúÏïÑ',
  'Ìò∏Ï£º',
  'ÎÖ∏Ìä∏Î∂Å',
  'Ìï∏ÎìúÌè∞',
  'Ïù¥Ïñ¥Ìè∞',
  'Ï∂©Ï†ÑÍ∏∞',
  'ÎßàÏù¥ÌÅ¨',
  'Ïπ¥Î©îÎùº',
  'ÏÇºÍ∞ÅÎåÄ',
  'Î∞∞ÌÑ∞Î¶¨',
  'Îû®ÌîÑ',
  'ÏãúÍ≥Ñ',
  'ÌÜ†ÎÅº',
  'Ìò∏ÎûëÏù¥',
  'ÏÇ¨Ïûê',
  'ÏΩîÎÅºÎ¶¨',
  'Í∏∞Î¶∞',
  'ÏõêÏà≠Ïù¥',
  'Ïó¨Ïö∞',
  'ÎäëÎåÄ',
  'Í≥†ÏñëÏù¥',
  'Í∞ïÏïÑÏßÄ',
  'ÎÜçÍµ¨',
  'Ï∂ïÍµ¨',
  'ÏïºÍµ¨',
  'Î∞∞Íµ¨',
  'ÌÉÅÍµ¨',
  'Ïî®Î¶Ñ',
  'Îã¨Î¶¨Í∏∞',
  'ÏûêÏ†ÑÍ±∞',
  'ÏàòÏòÅ',
  'Ïä§ÌÇ§',
  'ÌôîÏöîÏùº',
  'ÏõîÏöîÏùº',
  'ÏàòÏöîÏùº',
  'Î™©ÏöîÏùº',
  'Í∏àÏöîÏùº',
  'ÌÜ†ÏöîÏùº',
  'ÏùºÏöîÏùº',
  'Ïò§Îäò',
  'Ïñ¥Ï†ú',
  'ÎÇ¥Ïùº',
  'ÏÇ¨Î¨¥Ïã§',
  'ÌöåÏùòÏã§',
  'ÏãùÎãπ',
  'ÌôîÏû•Ïã§',
  'Í≥ÑÎã®',
  'Î≥µÎèÑ',
  'Ï∂úÏûÖÎ¨∏',
  'Ï∞ΩÎ¨∏',
  'Ï±ÖÏÉÅ',
  'Ïã†Î¨∏',
  'Ïû°ÏßÄ',
  'ÎßåÌôî',
  'ÎèôÌôî',
  'ÏÜåÏÑ§',
  'Î¨∏Ìïô',
  'Í≥ºÌïô',
  'Ïó≠ÏÇ¨',
  'Ï≤†Ìïô',
  'Î≤ÑÌäº',
  'ÌôîÎ©¥',
  'ÏÑ§Ï†ï',
  'ÌååÏùº',
  'Ìè¥Îçî',
  'Ïù¥Î©îÏùº',
  'Ï£ºÏÜå',
  'ÎπÑÎ∞ÄÎ≤àÌò∏',
];

// =====================================
//  Ïú†Ìã∏ Ìï®Ïàò Ï†ïÏùò
// =====================================

// Î¨¥ÏûëÏúÑ Îã®Ïñ¥ Î∞òÌôò
function getRandomWord() {
  return words[Math.floor(Math.random() * words.length)];
}

// Îã®Ïñ¥ X Ï¢åÌëú Î¨¥ÏûëÏúÑ ÏÑ§Ï†ï
function getRandomX() {
  const maxWidth = 1550;
  return Math.floor(Math.random() * (maxWidth - 100));
}

// Ï†êÏàò UI ÏóÖÎç∞Ïù¥Ìä∏
function updateScore() {
  scoreDisplay.textContent = `Ï†êÏàò: ${score}`;
}

// ÏãúÍ∞Ñ UI ÏóÖÎç∞Ïù¥Ìä∏
function updateTime() {
  timeDisplay.textContent = `ÏãúÍ∞Ñ: ${time}Ï¥à`;
}

// Î™®Îì† ÎÇôÌïò Îã®Ïñ¥Ïùò ÌÉÄÏù¥Î®∏ Ï†úÍ±∞
function clearFallingIntervals() {
  fallingIntervals.forEach(clearInterval);
  fallingIntervals.length = 0;
}

// =====================================
//  Í≤åÏûÑ Ï¢ÖÎ£å Ï≤òÎ¶¨
// =====================================
function gameOver() {
  clearInterval(dropInterval); // Îã®Ïñ¥ ÏÉùÏÑ± Ï§ëÎã®
  clearInterval(timerInterval); // ÏãúÍ∞Ñ Í∞êÏÜå Ï§ëÎã®
  clearFallingIntervals(); // ÎÇôÌïò Îã®Ïñ¥ Ïù∏ÌÑ∞Î≤å Ï†ïÎ¶¨

  finalScoreDisplay.textContent = score; // ÏµúÏ¢Ö Ï†êÏàò ÌëúÏãú
  gameOverModal.hidden = false; // Î™®Îã¨ Î≥¥Ïù¥Í∏∞
  typingInput.disabled = true; // ÏûÖÎ†•Ï∞Ω ÎπÑÌôúÏÑ±Ìôî
  document.querySelectorAll('.falling-word').forEach((el) => el.remove()); // Îã®Ïñ¥ Ï†úÍ±∞

  retryBtn.blur(); // ÏûêÎèô Ìè¨Ïª§Ïä§ Ï†úÍ±∞
  focusedButtonIndex = -1; // Î∞©Ìñ•ÌÇ§ Ìè¨Ïª§Ïä§ Ï¥àÍ∏∞Ìôî
}

// ====================================
//   Ïπ¥Ïö¥Ìä∏ Îã§Ïö¥
//=====================================
function startCountdown(callback) {
  const countdownEl = document.getElementById('countdown');
  let count = 3;

  countdownEl.hidden = false;
  countdownEl.textContent = count;

  const interval = setInterval(() => {
    count--;
    if (count === 0) {
      clearInterval(interval);
      countdownEl.hidden = true;
      callback(); // Ïã§Ï†ú Í≤åÏûÑ ÏãúÏûë
    } else {
      countdownEl.textContent = count;
      countdownEl.style.animation = 'none';
      void countdownEl.offsetWidth; // Î¶¨ÌîåÎ°úÏö∞
      countdownEl.style.animation = '';
    }
  }, 1000);
}

// =====================================
//  Í≤åÏûÑ ÏãúÏûë
// =====================================
function startGame() {
  clearInterval(dropInterval);
  clearInterval(timerInterval);
  clearFallingIntervals();

  score = 0;
  time = 60;
  updateScore();
  updateTime();
  typingInput.disabled = false;
  typingInput.value = '';
  gameOverModal.hidden = true;

  document.querySelectorAll('.falling-word').forEach((el) => el.remove());

  // ÌÉÄÏù¥Î®∏ ÏãúÏûë
  timerInterval = setInterval(() => {
    updateTime();
    if (time <= 0) {
      gameOver();
    } else {
      time--;
    }
  }, 1000);

  // Îã®Ïñ¥ ÏÉùÏÑ± ÏãúÏûë
  dropInterval = setInterval(() => {
    dropWord();
  }, 1000);

  // ÌÉÄÏûêÏ∞Ω Ìè¨Ïª§Ïä§
  setTimeout(() => {
    typingInput.focus();
  }, 100);
}

// =====================================
//  Îã®Ïñ¥ ÎÇôÌïò Í∏∞Îä•
// =====================================
function dropWord() {
  const wordEl = document.createElement('div');
  wordEl.className = 'falling-word';
  wordEl.textContent = getRandomWord();

  // Îπ®Í∞Ñ Îã®Ïñ¥Ïùº ÌôïÎ•† 20%
  if (Math.random() < 0.2) {
    wordEl.classList.add('red');
    wordEl.style.color = '#D13032';
  } else {
    wordEl.style.color = '#0F1E69';
  }

  // ÏúÑÏπò Î∞è Ïä§ÌÉÄÏùº
  wordEl.style.position = 'absolute';
  wordEl.style.left = `${getRandomX()}px`;
  wordEl.style.top = `0px`;
  wordEl.style.fontWeight = 'bold';
  wordEl.style.fontSize = '1.75rem';
  wordEl.style.pointerEvents = 'none';
  wordEl.style.userSelect = 'none';

  document.querySelector('.acidrain-bg').append(wordEl);

  let y = 0;
  let hasFallen = false;

  const interval = setInterval(() => {
    // ÌôîÎ©¥Ïóê ÏóÜÏúºÎ©¥ Ï†ïÎ¶¨
    if (!document.body.contains(wordEl)) {
      clearInterval(interval);
      return;
    }

    y += 2;
    wordEl.style.top = `${y}px`;

    if (y > 700 && !hasFallen) {
      hasFallen = true;
      clearInterval(interval);
      wordEl.remove();

      time -= 5;
      if (time < 0) time = 0;
      updateTime();
      if (time <= 0) gameOver();
    }
  }, 30);

  fallingIntervals.push(interval);
}

// =====================================
// Îã®Ïñ¥ Ï†úÍ±∞ Ìö®Í≥ºÏùå Ìï®Ïàò
// =====================================
function playPopSound() {
  const popSound = new Audio('/assets/audio/sfx/droplet-sound.mp3'); // Ìö®Í≥ºÏùå Í≤ΩÎ°ú
  popSound.volume = 0.7;
  popSound.playbackRate = 2.0; // Îçî Îπ†Î•¥Í≤å Ïû¨ÏÉù (Í∏∞Î≥∏ÏùÄ 1.0)
  popSound.play();
}

// =====================================
//  ÌÉÄÏûê ÏûÖÎ†• Í≤ÄÏÇ¨
// =====================================
typingInput.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;

  const typed = typingInput.value.trim();
  const fallingWords = document.querySelectorAll('.falling-word');

  for (const wordEl of fallingWords) {
    if (typed === wordEl.textContent) {
      const isRed = wordEl.classList.contains('red');
      score += isRed ? 15 : 10;
      wordEl.remove(); // Îß§Ïπ≠ Îã®Ïñ¥ Ï†úÍ±∞

      playPopSound(); // ‚úÖ Ïó¨Í∏∞ÏÑúÎßå Ìö®Í≥ºÏùå Ïû¨ÏÉù

      break; // ÌïòÎÇòÎßå Ï≤òÎ¶¨
    }
  }

  typingInput.value = '';
  updateScore();
});

// =====================================
//  Î©îÏù∏ Î≤ÑÌäº
// =====================================
const goHomeBtn = document.getElementById('goHomeBtn');

goHomeBtn.addEventListener('click', () => {
  loadHTML('/src/pages/game-landing/acidrain-landing.html'); // ‚Üê ÏÇ∞ÏÑ±ÎπÑ Î†åÎî© ÌéòÏù¥ÏßÄ Í≤ΩÎ°ú
});

// Enter ÎòêÎäî SpaceÎ°ú Îã§Ïãú ÏãúÏûë Í∞ÄÎä•
retryBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    startGame();
  }
});

// =====================================
//  Î∞©Ìñ•ÌÇ§Î°ú Î™®Îã¨ Î≤ÑÌäº Ìè¨Ïª§Ïä§ Ïù¥Îèô
// =====================================
document.addEventListener('keydown', (e) => {
  if (gameOverModal.hidden) return;

  if (e.key === 'ArrowRight') {
    // Ï≤òÏùå ÎàÑÎ•º Í≤ΩÏö∞ Ï≤´ Î≤àÏß∏Î°ú
    focusedButtonIndex = focusedButtonIndex === -1 ? 0 : (focusedButtonIndex + 1) % modalButtons.length;
    modalButtons[focusedButtonIndex].focus();
  }

  if (e.key === 'ArrowLeft') {
    focusedButtonIndex = focusedButtonIndex === -1 ? modalButtons.length - 1 : (focusedButtonIndex - 1 + modalButtons.length) % modalButtons.length;
    modalButtons[focusedButtonIndex].focus();
  }
});

// =====================================
//   ÏµúÏ¥à Í≤åÏûÑ ÏãúÏûë
// =====================================
// ‚úÖ 3,2,1 Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌõÑ Í≤åÏûÑ ÏãúÏûë
startCountdown(startGame);

// Îã§ÏãúÌïòÍ∏∞ Î≤ÑÌäº (ÌÅ¥Î¶≠)
retryBtn.addEventListener('click', () => {
  gameOverModal.hidden = true;
  startCountdown(startGame); // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌõÑ Ïã§Ï†ú Í≤åÏûÑ ÏãúÏûë
});
